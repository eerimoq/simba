:mod:`harness` --- Test harness
===============================

.. module:: harness
   :synopsis: Test harness.

In software testing, a test harness or automated test framework is a
collection of software and test data configured to test a program unit
by running it under varying conditions and monitoring its behavior and
outputs. It has two main parts: the test execution engine and the test
script repository.

This module implements the test execution engine.

The test scripts are part of the build system.

Stubs
-----

Symbols can be stubbed per C-file using the ``STUB()`` macro and
``STUB`` make variable. The ``STUB`` make variable is a list of source
files and the symbols to stub within given file.

For example, stub functions ``foo_bar()`` and ``foo_fie()`` in
``fum.c`` by defining stub functions ``STUB(foo_bar)()`` and
``STUB(foo_fie)()``, and set the make variable ``STUB`` to
``fum.c:foo_bar,foo_fie``.

Prototypes for ``foo_bar()`` and ``foo_fie()`` in ``foo.h``:

.. code-block:: c

   /**
    * The bar function.
    */
   int foo_bar();

   /**
    * The fie function.
    */
   int foo_fie();

``foo_bar()`` and ``foo_fie()`` called in ``fum.c``. Both function
calls will call the stubbed version on the respective function.

.. code-block:: c

   int fum_init()
   {
      foo_bar();
      foo_fie();

      return (0);
   }

The stubbed implementations, often defined in the test suite file
``main.c``:

.. code-block:: c

   int STUB(foo_bar)()
   {
       return (0);
   }

   int STUB(foo_fie)()
   {
       return (0);
   }

And last, add the stubbed symbol to the test suite makefile
``Makefile``:

.. code-block:: makefile

   STUB = fum.c:foo_bar,foo_fie

Mocking
-------

The test harness also supports function mocking with
``mock_write_*()`` and ``STUB(*)`` functions. These functions are
generated by the script :github-blob:`stub.py<bin/stub.py>`.

For example, generate a mock stub of ``foo.h`` with the command
``stub.py generate foo.h .``. Two files are created; ``foo_mock.h``
and ``foo_mock.c``. Include ``foo_mock.h`` in the test suite and call
``mock_write_*()`` to prepare the stub for function calls. The stub
will verify that all input arguments matches their expected values,
and write data to output arguments.

.. note:: The user may have to manually modify parts of the generated
          stubs to match her use case, as the stub script does not
          handle all situations properly.

.. code-block:: c

   #include "simba.h"
   #include "foo_mock.h"

   static int test_init(void)
   {
       /* Make foo_bar() return 1 and foo_fie() 5 once called. */
       mock_write_foo_bar(1);
       mock_write_foo_fie(5);

       BTASSERT(fum_init() == 0);

       return (0);
   }

   int main()
   {
       struct harness_testcase_t harness_testcases[] = {
           { test_init, "test_init" },
           { NULL, NULL }
       };

       sys_start();

       harness_run(harness_testcases);

       return (0);
   }

Add the stub source file to the list of files to build.

.. code-block:: makefile

   STUB = fum.c:foo_bar,foo_fie
   SRC += foo_mock.c

Example test suite
------------------

Below is an example of a test suite using the harness. It has three
test cases; ``test_passed``, ``test_failed`` and ``test_skipped``.

The test macro ``BTASSERT(condition)`` should be used to validate
conditions.

.. code-block:: c

   #include "simba.h"

   static int test_passed(void)
   {
       /* Return zero(0) when a test case passes. */
       return (0);
   }

   static int test_failed(void)
   {
       /* Return a negative integer when a test case fails. BTASSERT
          will return -1 when the condition is false. */
       BTASSERT(0);

       return (0);
   }

   static int test_skipped(void)
   {
       /* Return a positive integer when a test case is skipped. */
       return (1);
   }

   int main()
   {
       /* Test harness and NULL terminated list of test cases.*/
       struct harness_testcase_t harness_testcases[] = {
           { test_passed, "test_passed" },
           { test_failed, "test_failed" },
           { test_skipped, "test_skipped" },
           { NULL, NULL }
       };

       sys_start();

       harness_run(harness_testcases);

       return (0);
   }

The output from the test suite is:

.. code-block:: text

   app:    test_suite-7.0.0 built 2016-07-25 17:38 CEST by erik.
   board:  Linux
   mcu:    Linux

   enter: test_passed
   exit: test_passed: PASSED

   enter: test_failed
   exit: test_failed: FAILED

   enter: test_skipped
   exit: test_skipped: SKIPPED

               NAME        STATE  PRIO   CPU  LOGMASK
               main      current     0    0%     0x0f
                           ready   127    0%     0x0f
   harness report: total(3), passed(1), failed(1), skipped(1)

There are plenty of test suites in the :github-tree:`tst<tst>` folder
on Github.

---------------------------------------------------

Source code: :github-blob:`src/debug/harness.h`, :github-blob:`src/debug/harness.c`

---------------------------------------------------

.. doxygenfile:: debug/harness.h
   :project: simba
